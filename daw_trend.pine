//@version=5
indicator("Dow Theory + ICT Fair Value Gap - Fixed (trendPrev added)", overlay=true, max_labels_count=500)

// === Parameters ===
swingLen = input.int(4, "Swing Length (短期構造用)", minval=2)
confirmBars = input.int(2, "Reversal Confirm Bars", minval=1)
showLabels = input.bool(true, "Show HH/HL/LH/LL Labels")
showReversal = input.bool(true, "Show Reversal Arrows")
showFVG = input.bool(true, "Show Fair Value Gaps")

// === Swing Detection ===
isSwingHigh = high[swingLen] == ta.highest(high, swingLen * 2 + 1)
isSwingLow  = low[swingLen]  == ta.lowest(low, swingLen * 2 + 1)

// === State variables ===
var float lastHigh = na
var float lastLow = na
var string currentStruct = ""
var int trend = 0
var int trendPrev = 0  // ← ここで宣言しておく！

// === Structure Identification ===
if isSwingHigh
    currentStruct := na(lastHigh) ? "HH" : (high[swingLen] > lastHigh ? "HH" : "LH")
    lastHigh := high[swingLen]

if isSwingLow
    currentStruct := na(lastLow) ? "LL" : (low[swingLen] > lastLow ? "HL" : "LL")
    lastLow := low[swingLen]

// === Trend Direction ===
if currentStruct == "HH" or currentStruct == "HL"
    trend := 1
else if currentStruct == "LH" or currentStruct == "LL"
    trend := -1

// === Reversal Detection ===
trendPrev := nz(trend[confirmBars])      // confirmBars本前のtrendを取得（未定義時は0）
reversalSignal = trend != trendPrev

// === Labels ===
if showLabels and currentStruct != ""
    lblColor = (currentStruct == "HH" or currentStruct == "HL") ? color.new(color.lime, 0) : color.new(color.red, 0)
    lblY = (currentStruct == "HH" or currentStruct == "LH") ? high[swingLen] : low[swingLen]
    label.new(bar_index - swingLen, lblY, text=currentStruct, style=label.style_label_left, color=lblColor, textcolor=color.white)

// === Reversal Arrow Conditions ===
// ここでの定義は単純に真偽値を作るだけ（下で plotshape を呼ぶ）
bullReversal = showReversal and reversalSignal and trend == 1
bearReversal = showReversal and reversalSignal and trend == -1

plotshape(series=bullReversal, title="Bullish Reversal", style=shape.triangleup, color=color.new(color.green, 0), size=size.small, location=location.belowbar)
plotshape(series=bearReversal, title="Bearish Reversal", style=shape.triangledown, color=color.new(color.red, 0), size=size.small, location=location.abovebar)

// === Fair Value Gap (ICT concept) ===
var box[] fvgBoxes = array.new_box()

if showFVG
    fvgUp = low[1] > high[2]    // Bullish FVG
    fvgDown = high[1] < low[2]  // Bearish FVG

    if fvgUp
        b = box.new(left=bar_index[2], right=bar_index, top=low[1], bottom=high[2], bgcolor=color.new(color.green, 80), border_color=color.new(color.green, 0))
        array.push(fvgBoxes, b)
    if fvgDown
        b = box.new(left=bar_index[2], right=bar_index, top=high[2], bottom=low[1], bgcolor=color.new(color.red, 80), border_color=color.new(color.red, 0))
        array.push(fvgBoxes, b)

    // 逆順ループで埋まったFVGを削除
    sz = array.size(fvgBoxes)
    if sz > 0
        i = sz - 1
        while i >= 0
            bx = array.get(fvgBoxes, i)
            top = box.get_top(bx)
            bottom = box.get_bottom(bx)
            if not na(top) and not na(bottom)
                if close >= bottom and close <= top
                    box.delete(bx)
                    array.remove(fvgBoxes, i)
            i -= 1

// === Background ===
bgcolor(trend == 1 ? color.new(color.green, 92) : trend == -1 ? color.new(color.red, 92) : na)